<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KOTH Transcript Search</title>
  <style>
    body {
      background: #1a1a1a;
      color: #e0e0e0;
      font-family: sans-serif;
      padding: 20px;
      display: flex;
      gap: 30px;
    }
    #left {
      width: 320px;
    }
    #right {
      flex-grow: 1;
      max-height: 90vh;
      overflow-y: auto;
      border-left: 1px solid #444;
      padding-left: 30px;
    }
    h1 {
      margin-bottom: 0.5em;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-bottom: 1em;
      font-size: 1rem;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin: 6px 0;
    }
    a {
      color: #36a3d9;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    mark {
      background: yellow;
      color: black;
    }
    .result-line {
      margin: 10px 0;
      padding: 10px;
      background: #222;
      border-left: 3px solid #36a3d9;
    }
    .result-episode {
      font-weight: bold;
      color: #999;
    }
    .quote {
      margin-top: 4px;
      white-space: pre-wrap;
    }
    #transcript {
      margin-top: 20px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

  <div id="left">
    <h1>KOTH Search</h1>
    <input type="text" id="search" placeholder="Search all transcripts..." />
    <div id="results"></div>
  </div>

  <div id="right">
    <h2 id="transcript-title">Transcript</h2>
    <div id="transcript">Select a result to load the full transcript.</div>
  </div>

  <script>
    const folder = 'scripts/';
    const files = [
      "King of the Hill S01E01 Pilot.txt",
      "King of the Hill S01E02 Square Peg.txt",
      "King of the Hill S01E03 Order of the Straight Arrow.txt",
      "King of the Hill S01E04 Hank's Got the Willies.txt"
      // Add more episodes here...
    ];

    const transcripts = {};  // filename â†’ full text
    const lineIndex = [];    // array of { file, line, text }

    const searchInput = document.getElementById("search");
    const resultsDiv = document.getElementById("results");
    const transcriptEl = document.getElementById("transcript");
    const transcriptTitleEl = document.getElementById("transcript-title");

    // Load and index all files
    files.forEach(file => {
      fetch(folder + file)
        .then(res => res.text())
        .then(text => {
          transcripts[file] = text;
          const lines = text.split(/\r?\n/);
          lines.forEach((line, i) => {
            if (line.trim().length > 0) {
              lineIndex.push({ file, lineNumber: i + 1, text: line });
            }
          });
        });
    });

    function highlight(text, query) {
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }

    function renderSearchResults(query) {
      resultsDiv.innerHTML = '';
      if (!query || query.trim().length < 2) return;

      const q = query.toLowerCase();
      const matches = lineIndex.filter(entry => entry.text.toLowerCase().includes(q));

      if (matches.length === 0) {
        resultsDiv.innerHTML = "<p>No matches found.</p>";
        return;
      }

      matches.slice(0, 100).forEach(match => {
        const div = document.createElement('div');
        div.className = "result-line";

        const label = document.createElement('div');
        label.className = "result-episode";
        label.textContent = match.file.replace("King of the Hill ", "").replace(".txt", "");

        const quote = document.createElement('div');
        quote.className = "quote";
        quote.innerHTML = highlight(match.text, query);

        div.appendChild(label);
        div.appendChild(quote);
        div.onclick = () => {
          transcriptTitleEl.textContent = match.file.replace("King of the Hill ", "").replace(".txt", "");
          transcriptEl.innerHTML = highlight(transcripts[match.file], query);
          transcriptEl.scrollTop = 0;
        };

        resultsDiv.appendChild(div);
      });
    }

    searchInput.addEventListener("input", (e) => {
      renderSearchResults(e.target.value);
    });
  </script>
</body>
</html>
